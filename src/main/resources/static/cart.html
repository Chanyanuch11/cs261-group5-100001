<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üõí My Cart</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f4f4f4; }
        button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .remove-btn {
            background-color: #e74c3c;
            color: white;
        }
        .remove-btn:hover { background-color: #c0392b; }
        .checkout-btn {
            background-color: #2ecc71;
            color: white;
            padding: 10px 15px;
            margin-top: 15px;
        }
        .checkout-btn:hover { background-color: #27ae60; }
        .back-btn {
            background-color: #3498db;
            color: white;
            padding: 8px 12px;
            margin-right: 10px;
        }
        .back-btn:hover { background-color: #2980b9; }
        #total { font-weight: bold; font-size: 18px; margin-top: 15px; }
    </style>
</head>
<body>

    <h1>üõí My Shopping Cart</h1>
    <div id="userInfo"></div>

    <table id="cartTable">
        <thead>
            <tr>
                <th>Book Title</th>
                <th>Author</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="cartBody">
            <tr><td colspan="6">Loading cart...</td></tr>
        </tbody>
    </table>

    <p id="total">Total: $0.00</p>

    <button class="back-btn" onclick="goHome()">‚Üê Continue Shopping</button>
    <button class="checkout-btn" onclick="checkout()">‚úÖ Checkout</button>

    <script>
        const userId = localStorage.getItem("userId");
        const username = localStorage.getItem("username");
        const apiCart = "http://localhost:8080/api/cart";
        const apiOrders = "http://localhost:8080/api/orders";

        if (!userId) {
            alert("Please log in first!");
            window.location.href = "login.html";
        } else {
            document.getElementById("userInfo").innerText = `Welcome, ${username}`;
        }

        // ‚úÖ Load cart items
        function loadCart() {
            fetch(`${apiCart}/${userId}`)
                .then(res => res.json())
                .then(data => renderCart(data))
                .catch(err => console.error("Error loading cart:", err));
        }

        // ‚úÖ Render cart table
        function renderCart(items) {
            const body = document.getElementById("cartBody");
            body.innerHTML = "";
            let total = 0;

            if (items.length === 0) {
                body.innerHTML = `<tr><td colspan="6">Your cart is empty üï≥Ô∏è</td></tr>`;
                document.getElementById("total").innerText = "Total: $0.00";
                return;
            }

            items.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.title}</td>
                    <td>${item.author}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>$${subtotal.toFixed(2)}</td>
                    <td><button class="remove-btn" onclick="removeItem(${item.id})">Remove</button></td>
                `;
                body.appendChild(tr);
            });

            document.getElementById("total").innerText = `Total: $${total.toFixed(2)}`;
        }

        // ‚úÖ Remove item
        function removeItem(id) {
            if (!confirm("Remove this item from cart?")) return;
            fetch(`${apiCart}/remove/${id}`, { method: "DELETE" })
                .then(res => {
                    if (res.ok) loadCart();
                    else alert("‚ùå Failed to remove item");
                })
                .catch(err => console.error("Error removing item:", err));
        }

        // ‚úÖ Checkout
        function checkout() {
            if (!confirm("Proceed to checkout?")) return;

            fetch(`${apiOrders}/checkout/${userId}`, { method: "POST" })
                .then(res => res.text())
                .then(msg => {
                    alert(msg);
                    window.location.href = "checkout.html";
                })
                .catch(err => console.error("Error during checkout:", err));
        }

        // ‚úÖ Back to Home
        function goHome() {
            window.location.href = "home.html";
        }

        // üöÄ Load cart on page load
        loadCart();
    </script>
</body>
</html>
