<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="stylesheet.css" />
  <link rel="stylesheet" href="./cart.css" />
  <title>üõí My Cart</title>
</head>
<body>
  <header class="sitebar">
    <div class="row">
      <div class="header-container" style="display:flex;align-items:center;gap:12px;width:100%;">
        <div class="logo"><img src="img/logo.png" alt="Bookstore Logo" /></div>
        <div class="search-bar" style="flex:1;display:flex;gap:8px;align-items:center;">
          <input type="text" placeholder="Search" aria-label="Search books" />
          <button aria-label="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
        </div>
        <div class="header-cart">
          <a href="cart.html" class="cart" aria-label="Open cart">
            <img src="img/cart-icon.svg" alt="" />
          </a>
        </div>
        <div class="header-profile">
          <a href="login.html" class="icon" aria-label="Login">
            <img src="img/BlankPF.png" alt="" />
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <a class="crumb" href="#" onclick="goHome()">‚Üê Continue Shopping</a>
    <h2 class="title">My Cart</h2>

    <section class="grid">
      <div>
        <div id="emptyState" style="display:none; color:var(--muted); padding:12px">
          Your cart is empty üï≥Ô∏è
        </div>

        <div class="itemlist" id="cartList"></div>

        <div id="placeholders">
          <div class="item skeleton">
            <div class="skel-thumb"></div>
            <div style="display:flex; flex-direction:column; gap:10px">
              <div class="skel" style="width:180px"></div>
              <div class="skel-sm" style="width:140px"></div>
              <div class="skel" style="width:80px; height:18px"></div>
            </div>
            <div style="display:flex; align-items:center;">
              <div class="skel-btn"></div>
            </div>
          </div>

          <div class="item skeleton">
            <div class="skel-thumb"></div>
            <div style="display:flex; flex-direction:column; gap:10px">
              <div class="skel" style="width:160px"></div>
              <div class="skel-sm" style="width:120px"></div>
              <div class="skel" style="width:60px; height:18px"></div>
            </div>
            <div style="display:flex; align-items:center;">
              <div class="skel-btn"></div>
            </div>
          </div>
        </div>

        <template id="cart-item-tpl">
          <div class="item">
            <img class="thumb" src="" alt="book" />
            <div class="meta">
              <b class="title"></b>
              <small class="author"></small>
              <div class="price"></div>
            </div>
            <div style="display:flex; align-items:center; gap:8px">
              <div class="qty">
                <button type="button" class="btn-dec">‚àí</button>
                <span class="qty-num">1</span>
                <button type="button" class="btn-inc">+</button>
              </div>
              <button class="remove">Remove</button>
            </div>
          </div>
        </template>
      </div>

      <aside class="summary">
        <h3>Order Summary</h3>
        <div class="rows">
          <div class="rowline"><span>Subtotal</span><b id="subtotal">‡∏ø0</b></div>
          <div class="rowline"><span>Shipping Fee</span><span id="shipping">‡∏ø0</span></div>
          <div class="rowline"><span>Discount</span><span id="discount">-‡∏ø0</span></div>
          <div class="rowline total"><span>Total</span><b id="grandTotal">‡∏ø0</b></div>
        </div>
        <button class="checkout" onclick="checkout()">Go to Checkout</button>
      </aside>
    </section>
  </main>

  <footer class="reference">
    <div class="foot">
      <h3>Reference</h3>
      <div class="cols">
        <div>
          <h4>Genre:</h4>
          <ul>
            <li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li>
            <li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li>
          </ul>
        </div>
        <div>
          <h4>FAQ:</h4>
          <ul>
            <li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li>
            <li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li>
          </ul>
        </div>
        <div>
          <h4>Contact us:</h4>
          <ul>
            <li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li><li>- xxxxxxxxxx</li>
            <li style="display:flex; align-items:center; gap:8px">üìû <span>000-000-0000</span></li>
          </ul>
        </div>
      </div>
      <div class="brandline">‚Äú‡∏™‡πÇ‡∏•‡πÅ‡∏Å‡∏ô‚Äù ‚Ä¢ Power by BookStore.com</div>
    </div>
  </footer>

  <div class="bottombar">
    <div class="barin">
      <div class="brand"><span class="book">üìö</span></div>
      <div class="copy">Power by BookStore.com</div>
      <div class="social">
        <a href="#" aria-label="YouTube">‚ñ∂Ô∏è</a>
        <a href="#" aria-label="Facebook">üìò</a>
        <a href="#" aria-label="Instagram">üì∑</a>
        <a href="#" aria-label="Mail">‚úâÔ∏è</a>
      </div>
    </div>
  </div>

  <script>
    const apiCart   = "http://localhost:8080/api/cart";
    const apiOrders = "http://localhost:8080/api/orders";
    const userIdRaw = localStorage.getItem("userId");
    const userId    = userIdRaw && userIdRaw !== "null" ? Number(userIdRaw) : null;

    if (!userId || !Number.isFinite(userId)) {
      alert("Please log in first.");
      window.location.href = "login.html";
    }

    const THB = n => `‡∏ø${n.toFixed(0)}`;

    function loadCart() {
      fetch(`${apiCart}/${userId}`)
        .then(res => res.json())
        .then(items => renderCart(items))
        .catch(err => console.error("Error loading cart:", err));
    }

    function renderCart(items) {
      const list = document.getElementById("cartList");
      const emptyState = document.getElementById("emptyState");
      const placeholders = document.getElementById("placeholders");
      const tpl = document.getElementById("cart-item-tpl");

      list.innerHTML = "";
      placeholders.style.display = "none";

      if (!items || items.length === 0) {
        emptyState.style.display = "block";
        updateSummary(0, 0, 0);
        return;
      }
      emptyState.style.display = "none";

      let subtotal = 0;
      items.forEach(it => {
        subtotal += it.price * it.quantity;
        const $ = tpl.content.cloneNode(true);
        $.querySelector(".thumb").src = "img/book-placeholder.png";
        $.querySelector(".title").textContent = it.title;
        $.querySelector(".author").textContent = it.author || "";
        $.querySelector(".price").textContent = THB(it.price);
        $.querySelector(".qty-num").textContent = it.quantity;

        $.querySelector(".remove").addEventListener("click", () => {
          if (!confirm("Remove this item from cart?")) return;
          fetch(`${apiCart}/remove/${it.id}`, { method: "DELETE" })
            .then(r => r.ok ? loadCart() : alert("Failed to remove item."))
            .catch(console.error);
        });

        $.querySelector(".btn-inc").addEventListener("click", () => {
          fetch(`${apiCart}/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, book: { id: it.bookId }, quantity: 1 })
          }).then(() => loadCart());
        });

        $.querySelector(".btn-dec").addEventListener("click", () => {
          if (it.quantity <= 1) {
            fetch(`${apiCart}/remove/${it.id}`, { method: "DELETE" }).then(() => loadCart());
          } else {
            fetch(`${apiCart}/add`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, book: { id: it.bookId }, quantity: -1 })
            }).then(() => loadCart());
          }
        });

        list.appendChild($);
      });

      const shipping = subtotal > 0 ? 40 : 0;
      const discount = 0;
      updateSummary(subtotal, shipping, discount);
    }

    function updateSummary(subtotal, shipping, discount) {
      document.getElementById("subtotal").textContent = THB(subtotal);
      document.getElementById("shipping").textContent = THB(shipping);
      document.getElementById("discount").textContent = `- ${THB(discount)}`;
      document.getElementById("grandTotal").textContent = THB(subtotal + shipping - discount);
    }

    function checkout() {
      if (!confirm("Proceed to checkout?")) return;
      fetch(`${apiOrders}/checkout/${userId}`, { method: "POST" })
        .then(res => res.text())
        .then(msg => {
          alert(msg);
          window.location.href = "checkout.html";
        })
        .catch(err => console.error("Error during checkout:", err));
    }

    function goHome() { window.location.href = "index.html"; }

    loadCart();
  </script>
</body>
</html>
